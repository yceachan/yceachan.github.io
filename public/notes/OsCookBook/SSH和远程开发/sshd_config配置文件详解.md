# Ubuntu /etc/ssh/ 目录下的配置文件详解

这篇文档详细解释了 `/etc/ssh` 目录中四个关键配置文件（`sshd_config`, `sshd_config.d/`, `ssh_config`, `ssh_config.d/`）的作用和优先级。

简单来说，**`sshd` 开头的是用于配置 SSH *服务器*（别人如何连接到你的 Ubuntu）**，而 **`ssh` 开头的是用于配置 SSH *客户端*（你的 Ubuntu 如何连接到别的机器）**。

---

### Part 1: SSH 服务器配置 (`sshd_config` 和 `sshd_config.d`)

这些配置决定了谁可以、以及如何通过 SSH 登录到您这台 Ubuntu 虚拟机。

#### 1. `/etc/ssh/sshd_config`
- **作用**: 这是 OpenSSH 服务器的 **主配置文件**。它包含了绝大多数的全局设置。
- **常见配置**:
    - `Port 22`：监听的端口号。
    - `PermitRootLogin prohibit-password`：是否允许 root 用户登录。
    - `PasswordAuthentication yes`：是否允许使用密码登录。
    - `PubkeyAuthentication yes`：是否允许使用密钥对登录。
- **总结**: 这是您配置 SSH 服务器行为的核心文件。

#### 2. `/etc/ssh/sshd_config.d/`
- **作用**: 这是一个 **配置片段目录**。该目录下的 `.conf` 文件用于补充或覆盖 `sshd_config` 中的设置。
- **目的**:
    - **模块化**: 您可以按功能将配置拆分到不同文件中（例如，`50-security.conf`, `60-logging.conf`）。
    - **易于管理**: 当其他软件（如 `fail2ban`）需要修改 SSH 配置时，它们可以安全地在此目录中添加一个文件，而无需直接修改 `sshd_config` 主文件，从而避免了在软件升级时可能发生的冲突。
- **总结**: 用于存放零散、模块化或由其他软件包自动生成的服务器配置文件。

#### 服务器配置的优先级
配置的加载和生效遵循一个简单的规则：**后面读取的配置会覆盖前面读取的相同配置**。

1.  系统首先读取 `/etc/ssh/sshd_config`。
2.  然后，系统按 **字母顺序** 读取 `/etc/ssh/sshd_config.d/` 目录下的所有 `.conf` 文件。
3.  **最终生效的规则是“后来者居上”**。例如，如果在 `sshd_config` 中设置了 `Port 22`，但在 `sshd_config.d/99-custom.conf` 文件中设置了 `Port 2222`，那么 SSH 服务器最终会监听 `2222` 端口。

---

### Part 2: SSH 客户端配置 (`ssh_config` 和 `ssh_config.d`)

这些配置决定了当您在这台 Ubuntu 虚拟机上使用 `ssh` 命令去连接其他服务器时的默认行为。

#### 1. `/etc/ssh/ssh_config`
- **作用**: 这是 SSH 客户端的 **系统级默认配置文件**。
- **目的**: 为系统上的 **所有用户** 提供一套统一的 SSH 客户端默认设置。例如，您可以设置一些全局的 `KeepAlive` 选项或禁用对某些已知不安全加密算法的使用。
- **常见配置**:
    ```
    Host *
        SendEnv LANG LC_*
        HashKnownHosts yes
        GSSAPIAuthentication yes
    ```
- **总结**: 为本机所有用户设置的全局客户端默认值。

#### 2. `/etc/ssh/ssh_config.d/`
- **作用**: 与 `sshd_config.d` 类似，这是一个 **客户端配置片段目录**。该目录下的 `.conf` 文件用于补充或覆盖 `ssh_config` 中的设置。
- **目的**: 同样是为了模块化管理和方便其他软件包集成。例如，一个特定的应用程序可以添加一个配置文件来简化对其管理服务器的连接。
- **总结**: 用于存放零散的、系统级的客户端配置文件。

#### 客户端配置的优先级
客户端的配置层级更多，规则也略有不同：**最先匹配到的规则生效**。

从高到低，优先级顺序如下：

1.  **命令行选项**: 最高优先级。例如 `ssh -p 2222 user@host` 会无视任何配置文件中的端口设置。
2.  **用户个人配置文件**: `~/.ssh/config`。这是 **最常用** 的用户自定义配置文件，仅对当前用户生效。它会覆盖系统级的设置。
3.  **系统级配置文件**:
    *   首先读取 `/etc/ssh/ssh_config`。
    *   然后按 **字母顺序** 读取 `/etc/ssh/ssh_config.d/` 目录下的 `.conf` 文件。

**关键区别**: 与服务器端“后来者居上”不同，客户端在解析配置文件时，对于一个特定的连接参数（如 `Port`），它会使用 **它找到的第一个匹配的设置**，然后停止寻找该参数。所以 `~/.ssh/config` 中的设置会优先于 `/etc/ssh/ssh_config` 中的设置。

### 总结表格

| 文件/目录                | 范围     | 作用                                         | 优先级规则                               |
| ------------------------ | -------- | -------------------------------------------- | ---------------------------------------- |
| `sshd_config`            | **服务器** | SSH **服务器** 的主配置文件（用于入站连接）  | **后来者居上** (被 `.d` 目录中的配置覆盖) |
| `sshd_config.d/`         | **服务器** | SSH **服务器** 的配置片段目录                | 按字母顺序加载，**覆盖** 主配置           |
| `ssh_config`             | **客户端** | SSH **客户端** 的系统级默认配置（用于出站连接） | **先到先得** (被用户配置或命令行覆盖)     |
| `ssh_config.d/`          | **客户端** | SSH **客户端** 的系统级配置片段目录          | 按字母顺序加载，**被** 用户配置覆盖       |
