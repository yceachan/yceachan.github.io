# 内网互通环境准备

## 内网静态IP分配

**设备** ：

windows PC

Vmware linux 16（厂家配套虚拟机）

嵌入式开发板：imx6ull pro，韦东山

pc与开发板连接到同一路由，由路由根据MAC 分配静态ip地址。

vmware在`编辑->编辑网络模式`添加桥接模式网卡，绑定windows 内网网卡

vsl虚拟机添加双网卡设备

![image-20251221224647040](https://ali-oss-yceachan.oss-cn-chengdu.aliyuncs.com/img-bed-typora/image-20251221224647040.png) 

- 静态ip绑定

  查询三台设备的网卡mac，在路由器后台为其分配静态ip，三台设备的内网网卡选择dhcp模式，由路由分配网卡。

## 虚拟机NAT公网网络与双网卡路由配置

如上示意图在vmware配置虚拟机的双网卡，WLAN网络共享到NAT，LAN网络 桥接网卡，作内网通信使用。

需要配置路由规则，使得NAT网卡优先访问互联网

- 关键词： route metric via

## 防火墙配置

- Windows

  高级防火墙设置->入站/出站->操作->新建规则->在引导对话的作用域ip填写号段`192.168.0.0/24`号段

  > `/24`的含义: /24 表示这个地址的前24位是网络部分，剩下的 (32 - 24 = 8) 位是主机部分。
  >
  > 它定义了子网掩码。这种表示法被称为CIDR (无类域间路由)


## ssh配置

1. pc `ssh-keygen -t ed25519` 生成密钥

2. vsl `vi ~/.ssh/authorized_keys` 新行存储公钥

3. vsl `sudo vi /etc/ssh/sshd_config`  配置auth方式

   配置项目：`password` `key` 、

   在客户端、服务端各配置保活心跳包

## 虚拟机NAT网络访问外网

使用Clash 的Tun模式，勾选允许局域网连接。

此时虚拟机NAT网卡的流量会被CLASH的虚拟TUN网卡劫持，**全局代理所有流量**，从而实现VPN访问。**这个过程虚拟机是无感的**

但这也会导致，内网的ssh连接也会被代理，而VPN 不清楚内网路由的，导致ssh对话异常，出现

- **issue:** 
     **在使用vpn后一段时间内，ssh对话连接频繁断开，报错ERROR10053 （客户端主动断开连接）。**
     
- **解决方案**：

     这与不正确的路由配置有关，使得内网的ssh连接被vpn代理。

     在管理员cmd 窗口中使用route 命令来配置route规则表。

     目标是：对于`192.168.0.0/24`子网下的访问，一切经由gateway`192.168.0.1` 和interface`192.168.0.100`。

## 开发板mnt挂载虚拟机NFS目录

虚拟机开启了nfs服务，开发板直接运行如下命令

：`mount -t nfs -o nolock,vers=3 192.168.5.11:/home/book/nfs_rootfs /mnt`

将局域网下，将《ubuntu的某目录》设备挂载到自己的磁盘系统。

* 将以上命令配置在`/etc/pfofile` 中，以在login时自动挂载
* 开发板与虚拟机通过 `/mnt ` 与`nfs_rootfs` 互通文件。

