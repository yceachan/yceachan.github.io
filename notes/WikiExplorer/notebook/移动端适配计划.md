# WikiExplorer 移动端适配计划 (PWA First)

**创建日期**: 2026-01-20
**更新日期**: 2026-01-20
**状态**: 进行中 (In Progress)
**目标**: 基于 **PWA (Progressive Web App)** 技术，以最低成本实现 Android/iOS 端的类原生体验，并具备离线访问能力。同时保留未来微信小程序适配的可行性分析。

---

## 1. 核心技术决策 (Technical Decision)

### 1.1 为什么选择 PWA？
针对本项目（静态知识库、重阅读体验），PWA 提供了最佳的投入产出比：
*   **全平台兼容**: 一套代码同时适配 Android (Chrome), iOS (Safari), Desktop (Edge/Chrome)。
*   **离线能力**: 利用 Service Worker 实现“看一篇，存一篇”，完美契合笔记阅读场景。
*   **零安装**: 用户无需下载 APK/IPA，直接“添加到主屏幕”即可使用。
*   **开发成本**: 相比 React Native/Flutter，无需学习新语言，复用 100% 现有 React 代码。

### 1.2 微信小程序的特殊性 (暂缓适配)
微信小程序不支持标准 Web 环境（无 DOM，无 Service Worker），因此 **无法直接复用 PWA 方案**。
*   **难点**: 必须使用 `Taro` 或 `Uni-app` 重构。
*   **渲染瓶颈**: `react-markdown` 等依赖 DOM 的库无法使用，需替换为 `Towxml` 等专用解析库，不仅工作量大且样式难以统一。
*   **策略**: 暂缓。优先通过 PWA 覆盖 Android/iOS 用户。

---

## 2. PWA 适配实施流程 (Implementation Roadmap)

### 阶段一：基础架构改造 (Foundation)
**目标**: 让 Web 应用具备被“安装”的能力，并接管网络请求。

1.  **路由模式切换**:
    *   `BrowserRouter` -> **`HashRouter`**。
    *   **原因**: 兼容 GitHub Pages 非根目录部署，以及未来可能进行的 Capacitor 封装。
2.  **Vite 配置调整**:
    *   设置 `base: './'` 确保相对路径引用。
3.  **集成 `vite-plugin-pwa`**:
    *   配置 **Web App Manifest**: 定义应用名称、图标、启动背景色 (`standalone` 模式)。
    *   配置 **Service Worker**:
        *   **App Shell**: 预缓存 HTML/JS/CSS 核心资源。
        *   **Runtime Caching**: 对 `.md` 文件采用 `Stale-While-Revalidate` 策略（优先展示缓存，后台静默更新）。

### 阶段二：移动端 UI/UX 响应式适配 (Responsive UI)
**目标**: 将桌面端的“三栏布局”转化为符合移动端操作习惯的界面。

1.  **布局重构 (Mobile First)**:
    *   **默认视图**: 隐藏左侧 Profile 和右侧 TOC，仅显示中间的内容阅读区。
    *   **断点控制**: 使用 Tailwind `hidden md:block` 进行显隐控制。
2.  **导航交互升级**:
    *   **顶部导航栏 (Mobile Header)**: 新增移动端专用 Header。
    *   **抽屉导航 (Drawer)**:
        *   左滑/点击按钮 -> 呼出 **文件树 (File Tree)**。
        *   右滑/点击按钮 -> 呼出 **目录大纲 (TOC)**。
3.  **阅读体验优化**:
    *   **视口设置**: `user-scalable=no` 禁止缩放，模拟原生 App 触感。
    *   **内容适配**: 修复表格、代码块在小屏下的溢出问题（添加横向滚动）。
    *   **安全区域**: 适配 iPhone 刘海屏 (`viewport-fit=cover`, `env(safe-area-inset-top)`).

### 阶段三：部署与验证 (Deploy & Verify)
1.  **资产生成**: 生成 PWA 专用图标 (192, 512, Maskable)。
2.  **GitHub Actions**: 确保构建产物包含 `sw.js` 和 `manifest.webmanifest`。
3.  **真机测试**:
    *   iOS: Safari "添加到主屏幕"。
    *   Android: Chrome "安装应用"。
    *   **离线测试**: 开启飞行模式，验证已浏览过的笔记是否能正常加载。

---

## 3. 未来扩展性 (Future Proofing)

*   **Android APK 打包**: 如果未来需要上架应用商店，可直接引入 **Capacitor**，将现有的 PWA 包装为 APK，工作量仅需 1 天。
*   **iOS 独立 App**: 同样可通过 Capacitor + Mac 编译生成。

---

## 附录：关键配置片段

### Service Worker 缓存策略
```javascript
// vite.config.js (示意)
workbox: {
  runtimeCaching: [{
    urlPattern: ({ url }) => url.pathname.endsWith('.md'),
    handler: 'StaleWhileRevalidate',
    options: {
      cacheName: 'markdown-cache',
      expiration: { maxEntries: 500, maxAgeSeconds: 30 * 24 * 60 * 60 }
    }
  }]
}
```