# Agent 知识库迭代策略总结：文档先行模式

在开发者已有一定量的文档积累，或项目主要依赖文档作为“唯一真理来源（Source of Truth）”的场景下，Agent 的知识库配置应遵循**“索引-验证-按需加载”**的策略。以下是基于 Yichip 固件开发项目的实践总结。

## 0. 用户心得

> 此章节的知识库配置策略是全篇的高度凝练，设为最高优先级

- **文档先行**:

  - 用户给出的文档和笔记始终先于Agent的记忆，或经过Agent chat后，Agent记忆与文档并行。

  - **Agent吸收新的知识后，必须要在与topic对应的路径下的`GEMINI.md`层级里迭代记忆，并配置新的知识库索引。**

## 1. 核心原则
*   **文档即真理**: 所有的核心知识（架构、指令集、规范）必须持久化在文件系统（如 `notebook/`）中，而不是仅仅保留在 Agent 的对话历史或 Context Window 中。
*   **分层索引**: 使用 `GEMINI.md` 等特定文件作为知识索引（Index），而非知识容器（Container）。

## 2. 实施策略

### 2.1 静态层：分层索引体系 (Hierarchical Indexing)
不在一个文件中塞入所有知识，而是建立目录级的索引文件。

*   **项目根索引 (`/GEMINI.md`)**:
    *   **职责**: 定义项目全局结构、核心路径、全局记忆（如“总是先看 notebook”的指令）、以及子索引的入口。
    *   **内容**: 项目目录树解释、Todo List、跨目录的通用知识（如指令集摘要）。
*   **领域子索引: (`**/GEMIMI.md`)**:
    *   **职责**: 负责该特定领域内的知识导航。
    *   **内容**: 该目录下所有文档的功能简介、阅读推荐顺序、特定领域的最佳实践。

### 2.2 动态层:记忆刷新 (Git-Enhanced Refresh)
Agent 启动或被要求“刷新记忆”时，不应盲目读取全量文档，而是根据开发者prompt按需加载文档：

1.  **开发者显式提示：** 如开发者显式指明重构文档层级或新建笔记后后，触发知识库的更新和配置索引策略

2.  **变更检测**: 使用cli工具集、MCP工具集、Agent自己开发脚本等策略来验证更新，**并在对应topic的路径下的GEMINI.md**里修补知识库索引。

3.  **增量读取**:
    *   **无变更**: 信任当前的上下文缓存。
    *   **有变更**: 仅调用 `read_file` 读取发生变化的索引文件或具体文档。

4.  **按需深挖**: 仅在用户提问涉及到具体细节（如“详细解释 Patch 机制”）时，通过索引找到对应的详细文档（`芯片固件工程架构.md`）进行完整读取。

5.  **动态维护**:使用py脚本为md笔记文件维护header，范式如下：

    > **最后更新**: 2026-01-14
    > **状态**: `Stable`
    > **标签**: `Knowledge Base`, `Index`, `Boot`

    - 现有脚本路径：”notebook/update_headers.py“

### 2.3 进化层：从对话到文档的闭环 (Chat-to-Doc Pipeline)
防止 Agent 的 insightful 回答随会话结束而消失。

1.  **识别高价值信息**: 当 Agent 在对话中输出了经过推理的、源码分析得出的新知识（例如：梳理了 `boot` 启动流程）。
2.  **固化**: 开发者指示 Agent 将这部分信息整理为 Markdown 文件，写入 `notebook/`（例如：`Yichip-boot启动过程分析.md`）。
3.  **更新索引**: 立即更新对应相应层级的索引文件（`**/GEMINI.md`），将新文档纳入知识网络。
4.  **遗忘**: 在新的会话中，Agent 无需保留冗长的推理过程，只需保留“该知识已存在于某文档”的索引记忆即可。

## 3. 优势
*   **Token 效率**: 避免每次启动重复读取数万字的存量文档。
*   **准确性**: 确保 Agent 回答基于文件系统中最新的文档，而非过时的“幻觉”或旧记忆。
*   **可维护性**: 知识库与代码库同构，随 Git 提交一起演进，便于团队协作。
