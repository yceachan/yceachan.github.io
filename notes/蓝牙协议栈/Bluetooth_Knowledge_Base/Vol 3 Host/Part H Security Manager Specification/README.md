# Part H: Security Manager Specification

**Start Page:** 1630

## Table of Contents

- 1 Introduction (Page 1635)
  - 1.1 Scope (Page 1635)
  - 1.2 Conventions (Page 1635)
    - 1.2.1 Bit and byte ordering conventions (Page 1635)
    - 1.2.2 Random numbers (Page 1636)
- 2 Security Manager (Page 1637)
  - 2.1 Introduction (Page 1637)
  - 2.2 Cryptographic toolbox (Page 1639)
    - 2.2.1 Security function e (Page 1640)
    - 2.2.2 Random address hash function ah (Page 1640)
    - 2.2.3 Confirm value generation function c1 for LE legacy pairing (Page 1641)
    - 2.2.4 Key generation function s1 for LE legacy pairing (Page 1642)
    - 2.2.5 Function AES-CMAC (Page 1643)
    - 2.2.6 LE Secure Connections confirm value generation function f4 (Page 1643)
    - 2.2.7 LE Secure Connections key generation function f5 (Page 1644)
    - 2.2.8 LE Secure Connections check value generation function f6 (Page 1646)
    - 2.2.9 LE Secure Connections numeric comparison value generation function g2 (Page 1647)
    - 2.2.10 Link key conversion function h6 (Page 1648)
    - 2.2.11 Link key conversion function h7 (Page 1648)
  - 2.3 Pairing methods (Page 1649)
    - 2.3.1 Security Properties (Page 1650)
    - 2.3.2 IO capabilities (Page 1651)
    - 2.3.3 OOB authentication data (Page 1652)
    - 2.3.4 Encryption key size (Page 1652)
    - 2.3.5 Pairing algorithms (Page 1653)
      - 2.3.5.1 Selecting key generation method (Page 1653)
      - 2.3.5.2 LE legacy pairing - Just Works (Page 1656)
      - 2.3.5.3 LE legacy pairing - Passkey Entry (Page 1657)
      - 2.3.5.4 Out of band (Page 1658)
      - 2.3.5.5 LE legacy pairing phase 2 (Page 1658)
      - 2.3.5.6 LE Secure Connections pairing phase 2 (Page 1660)
        - 2.3.5.6.1 Public key exchange (Page 1660)
        - 2.3.5.6.2 Authentication stage 1 – Just Works or Numeric Comparison (Page 1661)
        - 2.3.5.6.3 Authentication stage 1 – Passkey Entry (Page 1663)
        - 2.3.5.6.4 Authentication stage 1 – Out of Band (Page 1665)
        - 2.3.5.6.5 Authentication stage 2 and long term key calculation (Page 1667)
      - 2.3.5.7 Cross-transport key derivation (Page 1668)
    - 2.3.6 Repeated attempts (Page 1668)
  - 2.4 Security in Bluetooth Low Energy (Page 1669)
    - 2.4.1 Definition of keys and values (Page 1669)
    - 2.4.2 Generation of distributed keys (Page 1670)
      - 2.4.2.1 Generation of IRK (Page 1670)
      - 2.4.2.2 Generation of CSRK (Page 1670)
      - 2.4.2.3 LE legacy pairing - generation of LTK, EDIV and Rand (Page 1670)
      - 2.4.2.4 Derivation of BR/EDR link key from LE LTK (Page 1671)
      - 2.4.2.5 Derivation of LE LTK from BR/EDR link key (Page 1671)
    - 2.4.3 Distribution of keys (Page 1672)
      - 2.4.3.1 LE legacy pairing key distribution (Page 1672)
      - 2.4.3.2 LE Secure Connections key distribution (Page 1673)
    - 2.4.4 Encrypted session setup (Page 1673)
      - 2.4.4.1 Encryption setup using STK (Page 1673)
      - 2.4.4.2 Encryption setup using LTK (Page 1674)
    - 2.4.5 Signing algorithm (Page 1675)
    - 2.4.6 Peripheral Security Request (Page 1676)
- 3 Security Manager Protocol (Page 1679)
  - 3.1 Introduction (Page 1679)
  - 3.2 Security Manager Channel over L2CAP (Page 1679)
  - 3.3 Command format (Page 1679)
  - 3.4 SMP timeout (Page 1680)
  - 3.5 Pairing methods (Page 1681)
    - 3.5.1 Pairing Request (Page 1681)
    - 3.5.2 Pairing Response (Page 1684)
    - 3.5.3 Pairing Confirm (Page 1686)
    - 3.5.4 Pairing Random (Page 1687)
    - 3.5.5 Pairing Failed (Page 1688)
    - 3.5.6 Pairing Public Key (Page 1690)
    - 3.5.7 Pairing DHKey Check (Page 1690)
    - 3.5.8 Keypress Notification (Page 1691)
  - 3.6 Security in Bluetooth Low Energy (Page 1691)
    - 3.6.1 Key distribution and generation (Page 1691)
    - 3.6.2 Encryption Information (Page 1695)
    - 3.6.3 Central Identification (Page 1696)
    - 3.6.4 Identity Information (Page 1696)
    - 3.6.5 Identity Address Information (Page 1697)
    - 3.6.6 Signing Information (Page 1698)
    - 3.6.7 Security Request (Page 1698)
- 4 References (Page 1700)
- Appendix A  EDIV and Rand Generation (Page 1701)
  - A.1 EDIV masking (Page 1701)
    - A.1.1 DIV mask generation function dm (Page 1701)
    - A.1.2 EDIV generation (Page 1702)
    - A.1.3 DIV recovery (Page 1702)
- Appendix B  Key Management (Page 1703)
  - B.1 Database lookup (Page 1703)
  - B.2 Key hierarchy (Page 1703)
    - B.2.1 Diversifying function d1 (Page 1704)
    - B.2.2 Generating keys from ER (Page 1705)
    - B.2.3 Generating keys from IR (Page 1705)
- Appendix C  Message sequence charts (Page 1707)
  - C.1 Phase 1: Pairing feature exchange (Page 1707)
    - C.1.1 Peripheral security request – Central requests pairing (Page 1708)
  - C.2 Phase 2: Authenticating and encrypting (Page 1708)
    - C.2.1 LE legacy pairing (Page 1708)
      - C.2.1.1 Legacy Phase 2: Short Term Key generation – Just Works (Page 1709)
      - C.2.1.2 Legacy Phase 2: Short Term Key generation – Passkey Entry (Page 1710)
      - C.2.1.3 Legacy Phase 2: Short Term Key generation – Out of Band (Page 1711)
    - C.2.2 LE Secure Connections (Page 1711)
      - C.2.2.1 Public key exchange (Page 1711)
      - C.2.2.2 Authentication stage 1 (Page 1712)
        - C.2.2.2.1 Successful Numeric Comparison (or Just Works) (Page 1712)
        - C.2.2.2.2 Numeric Comparison – Confirm Check failure on the Initiator side (Page 1714)
        - C.2.2.2.3 Numeric Comparison failure on the Initiator side (Page 1715)
        - C.2.2.2.4 Numeric Comparison failure on the Responding side (Page 1716)
        - C.2.2.2.5 Successful Passkey Entry (Page 1716)
        - C.2.2.2.6 Passkey Entry – Confirm Check failure on the Responder side (Page 1718)
        - C.2.2.2.7 Passkey Entry – Confirm Check failure on the Initiator side (Page 1719)
        - C.2.2.2.8 Passkey Entry failure on the Responding side (Page 1720)
        - C.2.2.2.9 Passkey Entry Failure on the Initiator Side (Page 1720)
        - C.2.2.2.10 Successful Out of Band (Page 1721)
        - C.2.2.2.11 Out of Band – Confirm Check failure on the Responder side (Page 1721)
        - C.2.2.2.12 Out of Band - Confirm Check failure on the Initiating side (Page 1722)
        - C.2.2.2.13 Out of Band Failure on the Initiator side (OOB information not available) (Page 1722)
        - C.2.2.2.14 Out of Band Failure on the Responding side (OOB information not available) (Page 1723)
      - C.2.2.3 Long Term Key calculation (Page 1723)
      - C.2.2.4 Authentication stage 2 (DHKey checks) (Page 1723)
  - C.3 Phase 3: Transport specific key distribution (Page 1725)
  - C.4 Security re-established using previously distributed LTK (Page 1725)
    - C.4.1 Central initiated security - Central initiated Link Layer encryption (Page 1725)
    - C.4.2 Peripheral security request - Central initiated Link Layer encryption (Page 1725)
  - C.5 Failure conditions (Page 1726)
    - C.5.1 Pairing not supported by Peripheral (Page 1726)
    - C.5.2 Central rejects pairing because of key size (Page 1726)
    - C.5.3 Peripheral rejects pairing because of key size (Page 1727)
    - C.5.4 Passkey Entry failure on Central (Page 1728)
    - C.5.5 Passkey Entry failure on Peripheral (Page 1729)
    - C.5.6 Peripheral rejects Central’s confirm value (Page 1729)
    - C.5.7 Central rejects Peripheral’s confirm value (Page 1730)
- Appendix D  Sample data (Page 1732)
  - D.1 AES-CMAC RFC4493 test vectors (Page 1732)
    - D.1.1 Example 1: Len = 0 (Page 1732)
    - D.1.2 Example 2: Len = 16 (Page 1732)
    - D.1.3 Example 3: Len = 40 (Page 1732)
    - D.1.4 Example 4: Len = 64 (Page 1732)
  - D.2 f4 LE SC confirm value generation function (Page 1732)
  - D.3 f5 LE SC key generation function (Page 1733)
  - D.4 f6 LE SC check value generation function (Page 1733)
  - D.5 g2 LE SC numeric comparison generation function (Page 1734)
  - D.6 h6 LE SC link key conversion function (Page 1734)
  - D.7 ah random address hash functions (Page 1734)
  - D.8 h7 LE SC link key conversion function (Page 1734)
  - D.9 LTK to link key conversion using CT2=1 (Page 1734)
  - D.10 LTK to link key conversion using CT2=0 (Page 1734)
  - D.11 Link key to LTK conversion using CT2=1 (Page 1735)
  - D.12 Link key to LTK conversion using CT2=0 (Page 1735)
